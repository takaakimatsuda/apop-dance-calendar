name: Weekly Events Summary

on:
  schedule:
    # 毎週金曜 JST 9:00 に実行 (UTC 0:00 金曜)
    # cron: '分 時 日 月 曜日'
    # 曜日: 0=日曜, 1=月曜, ..., 5=金曜
    - cron: '0 0 * * 5'

  # 手動実行も可能（テスト用）
  workflow_dispatch: {}

jobs:
  post-summary:
    runs-on: ubuntu-latest

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 依存関係インストール
        id: npm-install
        run: npm install
        continue-on-error: true

      - name: 依存関係インストール（リトライ）
        if: steps.npm-install.outcome == 'failure'
        run: |
          sleep 30
          npm install

      - name: 週次イベントまとめを生成・メール送信
        run: npm run test:weekly
        env:
          TZ: Asia/Tokyo
          # メール送信設定
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          # X API キー（後で追加する場合）
          # TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          # TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          # TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          # TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
