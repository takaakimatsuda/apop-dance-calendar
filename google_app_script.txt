// ===========================
// APOP Dance Calendar - Google Apps Script
// JSONP対応版（CORS問題解決）+ オーガナイザー情報追加版 + 定期開催イベント展開機能
// ===========================

function doGet(e) {
  try {
    // スプレッドシートからデータを取得
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();

    // C列（イベント名）の文字色を取得
    const fontColors = dataRange.getFontColors();

    let events = [];

    // 4行目から実際のイベントデータが始まる
    for (let i = 3; i < data.length; i++) {
      const row = data[i];

      // B列（日時）とC列（イベント名）が空の場合はスキップ
      if (!row[1] || row[1] === '' || row[1] === '定期イベント') continue;
      if (!row[2] || row[2] === '' || row[2] === 'イベント名') continue;

      // C列（イベント名、インデックス2）の文字色を確認
      const textColor = fontColors[i][2]; // i行目のC列の色

      // 赤色の判定（複数の赤色コードに対応）
      const isRed = textColor === '#ff0000' ||
                    textColor === '#FF0000' ||
                    textColor === '#cc0000' ||
                    textColor === '#CC0000' ||
                    textColor === '#ff0000ff' || // 透明度付きの場合
                    textColor === '#FF0000FF' ||
                    textColor.toLowerCase().includes('ff0000') ||
                    textColor.toLowerCase().includes('cc0000');

      const baseEvent = {
        date: row[1] || '',  // B列：日時
        eventDate: '', // 後で設定
        name: row[2] || '',  // C列：イベント名
        prefecture: row[3] || '', // D列：都道府県
        venue: row[4] || '', // E列：会場
        mainContent: row[5] || '', // F列：メインコンテンツ
        subContent: row[6] || '', // G列：サブコンテンツ
        status: row[7] || '', // H列：エントリー状況
        twitter: row[8] || '', // I列：X垢
        region: getRegion(row[3]), // 都道府県から地域を判定
        organizer: isRed ? 'ASHITAKA' : 'その他', // オーガナイザー情報を追加
        id: `event_${i}`,
        rowNumber: i + 1
      };

      // 定期イベントの判定と展開
      if (isRecurringEvent(baseEvent.date)) {
        const expandedEvents = expandRecurringEvent(baseEvent);
        events = events.concat(expandedEvents);
      } else {
        // 通常のイベント
        baseEvent.eventDate = parseEventDate(baseEvent.date);
        baseEvent.isRecurring = false;
        events.push(baseEvent);
      }
    }

    // イベントを日付順にソート
    events.sort((a, b) => {
      const dateA = new Date(a.eventDate || '2099-12-31');
      const dateB = new Date(b.eventDate || '2099-12-31');
      return dateA - dateB;
    });

    // オーガナイザー別の統計情報も追加
    const ashitakaEvents = events.filter(e => e.organizer === 'ASHITAKA');
    const otherEvents = events.filter(e => e.organizer === 'その他');

    // 定期開催イベントの統計
    const recurringEvents = events.filter(e => e.isRecurring);
    const oneTimeEvents = events.filter(e => !e.isRecurring);

    const stats = {
      total: events.length,
      upcoming: events.filter(e => {
        const eventDate = new Date(e.eventDate);
        return !isNaN(eventDate) && eventDate >= new Date();
      }).length,
      byOrganizer: {
        ASHITAKA: ashitakaEvents.length,
        その他: otherEvents.length
      },
      byType: {
        recurring: recurringEvents.length,
        oneTime: oneTimeEvents.length
      },
      lastUpdated: new Date().toISOString()
    };

    const response = {
      success: true,
      stats: stats,
      events: events
    };

    // JSONPコールバック対応
    const jsonString = JSON.stringify(response);
    const callback = e.parameter.callback;

    if (callback) {
      // JSONP形式で返す（CORS回避）
      return ContentService
        .createTextOutput(callback + '(' + jsonString + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      // 通常のJSON形式
      return ContentService
        .createTextOutput(jsonString)
        .setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    const errorResponse = {
      success: false,
      error: error.toString(),
      message: 'データの取得に失敗しました。シートの設定を確認してください。'
    };

    const jsonString = JSON.stringify(errorResponse);
    const callback = e.parameter.callback;

    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + jsonString + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService
        .createTextOutput(jsonString)
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}

// ===========================
// 定期開催イベント関連の関数
// ===========================

// 定期開催イベントかどうかを判定
function isRecurringEvent(dateStr) {
  if (!dateStr) return false;
  const str = dateStr.toString();
  return str.includes('毎月') || str.includes('毎週') || str.includes('定期');
}

// 定期開催イベントを実際の日付に展開
function expandRecurringEvent(baseEvent) {
  const dateStr = baseEvent.date.toString();
  const expandedEvents = [];

  // 展開する期間（当月と翌月の2ヶ月分）
  const today = new Date();
  const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
  const endDate = new Date(today.getFullYear(), today.getMonth() + 2, 0);

  // 「毎月第4金曜」のようなパターンを解析
  if (dateStr.match(/毎月第[1-5][日月火水木金土]曜/)) {
    const weekMatch = dateStr.match(/第([1-5])/);
    const dayMatch = dateStr.match(/([日月火水木金土])曜/);

    if (weekMatch && dayMatch) {
      const weekNum = parseInt(weekMatch[1]);
      const dayOfWeek = getDayOfWeekNumber(dayMatch[1]);

      if (dayOfWeek !== -1) {
        // 各月の該当日を生成
        for (let year = startDate.getFullYear(); year <= endDate.getFullYear(); year++) {
          const startMonth = (year === startDate.getFullYear()) ? startDate.getMonth() : 0;
          const endMonth = (year === endDate.getFullYear()) ? endDate.getMonth() : 11;

          for (let month = startMonth; month <= endMonth; month++) {
            const nthDay = getNthWeekday(year, month, dayOfWeek, weekNum);
            if (nthDay) {
              const eventCopy = Object.assign({}, baseEvent);
              eventCopy.date = formatDateJapanese(nthDay);
              eventCopy.eventDate = formatISODate(nthDay);
              eventCopy.isRecurring = true;
              eventCopy.recurringPattern = dateStr;
              eventCopy.id = `${baseEvent.id}_${formatISODate(nthDay)}`;
              expandedEvents.push(eventCopy);
            }
          }
        }
      }
    }
  }

  // 「毎週金曜」のようなパターン
  else if (dateStr.match(/毎週[日月火水木金土]曜/)) {
    const dayMatch = dateStr.match(/([日月火水木金土])曜/);

    if (dayMatch) {
      const targetDayOfWeek = getDayOfWeekNumber(dayMatch[1]);

      if (targetDayOfWeek !== -1) {
        // 期間内の全ての該当曜日を生成
        const current = new Date(startDate);
        while (current <= endDate) {
          if (current.getDay() === targetDayOfWeek) {
            const eventCopy = Object.assign({}, baseEvent);
            const dateCopy = new Date(current);
            eventCopy.date = formatDateJapanese(dateCopy);
            eventCopy.eventDate = formatISODate(dateCopy);
            eventCopy.isRecurring = true;
            eventCopy.recurringPattern = dateStr;
            eventCopy.id = `${baseEvent.id}_${formatISODate(dateCopy)}`;
            expandedEvents.push(eventCopy);
          }
          current.setDate(current.getDate() + 1);
        }
      }
    }
  }

  // 「毎月25日」のようなパターン
  else if (dateStr.match(/毎月(\d{1,2})日/)) {
    const dayMatch = dateStr.match(/毎月(\d{1,2})日/);
    const day = parseInt(dayMatch[1]);

    for (let year = startDate.getFullYear(); year <= endDate.getFullYear(); year++) {
      const startMonth = (year === startDate.getFullYear()) ? startDate.getMonth() : 0;
      const endMonth = (year === endDate.getFullYear()) ? endDate.getMonth() : 11;

      for (let month = startMonth; month <= endMonth; month++) {
        const targetDate = new Date(year, month, day);
        // その月に該当日が存在するかチェック（例：2月30日は存在しない）
        if (targetDate.getMonth() === month) {
          const eventCopy = Object.assign({}, baseEvent);
          eventCopy.date = formatDateJapanese(targetDate);
          eventCopy.eventDate = formatISODate(targetDate);
          eventCopy.isRecurring = true;
          eventCopy.recurringPattern = dateStr;
          eventCopy.id = `${baseEvent.id}_${formatISODate(targetDate)}`;
          expandedEvents.push(eventCopy);
        }
      }
    }
  }

  // パターンにマッチしない場合は、元のイベントを1つだけ返す
  if (expandedEvents.length === 0) {
    baseEvent.eventDate = getNextRecurringDate(baseEvent.date);
    baseEvent.isRecurring = true;
    baseEvent.recurringPattern = dateStr;
    baseEvent.status = '定期開催';
    expandedEvents.push(baseEvent);
  }

  return expandedEvents;
}

// 曜日名から曜日番号を取得（日曜=0, 月曜=1, ...）
function getDayOfWeekNumber(dayName) {
  const dayMap = {
    '日': 0, '月': 1, '火': 2, '水': 3,
    '木': 4, '金': 5, '土': 6
  };
  return dayMap[dayName] !== undefined ? dayMap[dayName] : -1;
}

// 指定月の第N週の指定曜日を取得
function getNthWeekday(year, month, dayOfWeek, weekNum) {
  const firstDay = new Date(year, month, 1);
  const firstDayOfWeek = firstDay.getDay();

  // 最初の該当曜日を見つける
  let daysUntilTarget = (dayOfWeek - firstDayOfWeek + 7) % 7;
  let targetDate = 1 + daysUntilTarget + (weekNum - 1) * 7;

  // 月内に存在するかチェック
  const result = new Date(year, month, targetDate);
  if (result.getMonth() === month) {
    return result;
  }
  return null;
}

// 日付フォーマット: "10/25(土)"
function formatDateJapanese(date) {
  const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = weekdays[date.getDay()];
  return `${month}/${day}(${weekday})`;
}

// ISO形式の日付: "2025-10-25"
function formatISODate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ===========================
// 既存の関数（変更なし）
// ===========================

function parseEventDate(dateStr) {
  if (!dateStr) return '';

  // "9/13(土)" 形式を "2025-09-13" に変換
  const match = dateStr.toString().match(/(\d{1,2})\/(\d{1,2})/);
  if (match) {
    const currentYear = new Date().getFullYear();
    const month = match[1].padStart(2, '0');
    const day = match[2].padStart(2, '0');

    // 月が過去の場合は来年と判断
    const currentMonth = new Date().getMonth() + 1;
    const eventMonth = parseInt(match[1]);
    const year = eventMonth < currentMonth ? currentYear + 1 : currentYear;

    return `${year}-${month}-${day}`;
  }

  return '';
}

function getNextRecurringDate(recurringInfo) {
  const today = new Date();

  if (recurringInfo.includes('毎月第')) {
    const match = recurringInfo.match(/毎月第(\d)(.曜)/);
    if (match) {
      const weekNumber = parseInt(match[1]);
      const dayName = match[2];
      const dayMap = { '日': 0, '月': 1, '火': 2, '水': 3, '木': 4, '金': 5, '土': 6 };
      const targetDay = dayMap[dayName];

      if (targetDay === undefined) return '';

      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const firstDay = new Date(currentYear, currentMonth, 1);
      const firstDayOfWeek = firstDay.getDay();

      let targetDate = 1 + (targetDay - firstDayOfWeek + 7) % 7 + (weekNumber - 1) * 7;
      let resultDate = new Date(currentYear, currentMonth, targetDate);

      if (resultDate < today) {
        const nextMonth = currentMonth + 1;
        const nextYear = nextMonth > 11 ? currentYear + 1 : currentYear;
        const actualMonth = nextMonth % 12;
        const nextFirstDay = new Date(nextYear, actualMonth, 1);
        const nextFirstDayOfWeek = nextFirstDay.getDay();
        targetDate = 1 + (targetDay - nextFirstDayOfWeek + 7) % 7 + (weekNumber - 1) * 7;
        resultDate = new Date(nextYear, actualMonth, targetDate);
      }

      return resultDate.toISOString().split('T')[0];
    }
  }

  return '';
}

function getRegion(prefecture) {
  if (!prefecture) return '';

  const regionMap = {
    '北海道': ['北海道'],
    '東北': ['青森', '岩手', '宮城', '秋田', '山形', '福島'],
    '関東': ['茨城', '栃木', '群馬', '埼玉', '千葉', '東京', '神奈川'],
    '中部': ['新潟', '富山', '石川', '福井', '山梨', '長野', '岐阜', '静岡', '愛知'],
    '関西': ['三重', '滋賀', '京都', '大阪', '兵庫', '奈良', '和歌山'],
    '中国': ['鳥取', '島根', '岡山', '広島', '山口'],
    '四国': ['徳島', '香川', '愛媛', '高知'],
    '九州': ['福岡', '佐賀', '長崎', '熊本', '大分', '宮崎', '鹿児島', '沖縄']
  };

  for (const [region, prefectures] of Object.entries(regionMap)) {
    for (const pref of prefectures) {
      if (prefecture && prefecture.includes(pref)) {
        return region;
      }
    }
  }

  return '不明';
}

// ===========================
// テスト関数（動作確認用）
// ===========================

// 通常のJSON形式でテスト
function testAPI() {
  const result = doGet({parameter: {}});
  const data = JSON.parse(result.getContent());
  console.log('イベント数:', data.events ? data.events.length : 0);
  if (data.events && data.events.length > 0) {
    console.log('最初のイベント:', data.events[0]);
    console.log('ASHITAKAイベント数:', data.stats.byOrganizer.ASHITAKA);
    console.log('その他イベント数:', data.stats.byOrganizer['その他']);
    console.log('定期開催イベント数:', data.stats.byType.recurring);
    console.log('単発イベント数:', data.stats.byType.oneTime);

    // 定期開催イベントの例を表示
    const recurringExamples = data.events.filter(e => e.isRecurring).slice(0, 3);
    console.log('定期開催イベントの例:', recurringExamples);
  }
  console.log('レスポンス:', data);
  return data;
}

// JSONP形式でテスト
function testJSONP() {
  const result = doGet({parameter: {callback: 'myCallback'}});
  const content = result.getContent();
  console.log('JSONP形式:', content.substring(0, 100) + '...');
  return content;
}

// オーガナイザー情報のテスト
function testOrganizer() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const dataRange = sheet.getDataRange();
  const fontColors = dataRange.getFontColors();

  console.log('=== 文字色チェック ===');
  for (let i = 3; i < Math.min(10, fontColors.length); i++) {
    const eventName = dataRange.getValues()[i][2];
    const color = fontColors[i][2];
    console.log(`行${i+1}: ${eventName} -> 色: ${color}`);
  }
}

// 定期開催イベント展開のテスト
function testRecurringExpansion() {
  console.log('=== 定期開催イベント展開テスト ===');

  const testEvents = [
    { date: '毎月第4金曜', name: 'テストイベント1' },
    { date: '毎週金曜', name: 'テストイベント2' },
    { date: '毎月25日', name: 'テストイベント3' }
  ];

  testEvents.forEach(event => {
    console.log(`\n元のイベント: ${event.date} - ${event.name}`);
    const expanded = expandRecurringEvent(event);
    console.log(`展開後: ${expanded.length}件`);
    if (expanded.length > 0) {
      console.log('最初の3件:');
      expanded.slice(0, 3).forEach(e => {
        console.log(`  - ${e.date} (${e.eventDate})`);
      });
    }
  });
}

// ===========================
// 静的JSON生成機能（オプション）
// GitHub Actionsを使わない場合の代替手段
// ===========================

function generateStaticJSON() {
  try {
    console.log('静的JSON生成開始...');

    // 通常のJSON形式でデータ取得
    const result = doGet({parameter: {}});
    const jsonData = result.getContent();

    // Google Driveに保存
    saveToGoogleDrive(jsonData);

    console.log('静的JSON生成完了');

  } catch (error) {
    console.error('静的JSON生成エラー:', error);
  }
}

function saveToGoogleDrive(jsonContent) {
  const fileName = 'apop-events.json';

  // 既存ファイルを検索
  const files = DriveApp.getFilesByName(fileName);

  if (files.hasNext()) {
    // 既存ファイルを更新
    const file = files.next();
    file.setContent(jsonContent);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    console.log('ファイル更新:', file.getUrl());
    console.log('ダウンロードURL:', file.getDownloadUrl());
    console.log('直接アクセスURL:', 'https://drive.google.com/uc?id=' + file.getId() + '&export=download');
  } else {
    // 新規ファイル作成
    const file = DriveApp.createFile(fileName, jsonContent, 'application/json');
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    console.log('ファイル作成:', file.getUrl());
    console.log('ダウンロードURL:', file.getDownloadUrl());
    console.log('直接アクセスURL:', 'https://drive.google.com/uc?id=' + file.getId() + '&export=download');
  }
}

// タイマートリガーを設定（初回のみ実行）
function setupDailyTriggers() {
  // 既存のトリガーを削除
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'generateStaticJSON') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // 朝9時のトリガー
  ScriptApp.newTrigger('generateStaticJSON')
    .timeBased()
    .atHour(9)
    .everyDays(1)
    .create();

  // 夕方18時のトリガー
  ScriptApp.newTrigger('generateStaticJSON')
    .timeBased()
    .atHour(18)
    .everyDays(1)
    .create();

  console.log('トリガー設定完了: 毎日9時と18時に実行');
}

// 手動実行用：今すぐJSONを生成
function manualGenerateJSON() {
  generateStaticJSON();
  SpreadsheetApp.getActiveSpreadsheet().toast('JSONファイルを更新しました', '完了', 3);
}

// ===========================
// デプロイ情報表示
// ===========================

function getDeploymentInfo() {
  const url = ScriptApp.getService().getUrl();
  console.log('=== デプロイ情報 ===');
  console.log('Web App URL:', url);
  console.log('');
  console.log('通常のJSON形式でアクセス:');
  console.log(url);
  console.log('');
  console.log('JSONP形式でアクセス（CORS回避）:');
  console.log(url + '?callback=handleEvents');
  console.log('');
  console.log('HTMLで使用する例:');
  console.log('<script src="' + url + '?callback=handleEvents"></script>');

  return url;
}
